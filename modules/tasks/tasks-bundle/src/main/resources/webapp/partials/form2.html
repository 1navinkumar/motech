<div ng-hide="task._id" class="box-header">{{msg('section.newTask')}} <a href="#/task/" type="button" class="btn btn-danger btn-in-header pull-right"><i class="icon-share icon-white"></i></a></div>
<div ng-show="task._id" class="box-header">{{msg('section.editTask')}} <a href="#/task/" type="button" class="btn btn-danger btn-in-header pull-right"><i class="icon-share icon-white"></i></a></div>
<div class="box-content">
    <div class="inside">
        <div ng-show="true || errors.length > 0" class="span12 alert alert-block alert-error">
            <div><strong>Error:</strong>&nbsp;Error Field &nbsp;Error Message</div>
        </div>
    </div>
    <div>
        <div class="row-fluid margin-before">
            <form class="inside task form-horizontal">
                <!------------------ ENTER TASK NAME ------------------>
                <div class="control-group" ng-class="{error: !task.name}">
                    <label class="control-label task-label">{{msg('task.name')}}</label>
                    <div class="controls">
                        <input class="span7" type='text' ng-model='task.name' id="task.name" maxlength="30"/>
                    </div>
                </div>

                <!------------------ ENTER TASK DESCRIPTION ------------------>
                <div class="control-group">
                    <label class="control-label task-label">{{msg('section.taskDescription')}}</label>
                    <div class="controls">
                        <textarea class="span7" ng-model="task.description"></textarea>
                    </div>
                </div>

                <!------------------ SELECT TRIGGER ------------------>
                <div class="accordion" id="select-trigger">
                    <div class="task-group">
                        <div class="accordion-heading">
                            <div class="pull-right">
                                <button type="button" class="btn btn-info btn-in-heading" data-toggle="collapse" data-target="#collapse-trigger">
                                    <i class="icon-plus-sign icon-white"></i>
                                </button>
                            </div>
                            <a class="accordion-toggle inbox-header" overflow-change="collapse-trigger" data-toggle="collapse" data-parent="#select-trigger" href="#collapse-trigger">
                                {{msg('header.trigger')}}
                                <span ng-hide="!task.trigger.displayName">
                                    &raquo; {{msg(task.trigger.channelName)}} : {{msg(task.trigger.displayName)}}
                                </span>
                            </a>
                        </div>
                        <div id="collapse-trigger" class="accordion-body stripes-bg collapse in" style="overflow: visible;">
                            <div class="accordion-inner">
                                <div class="section-source">
                                    <ul class="task-selector" style="position: relative;">
                                        <li class="task-panel" style="cursor: pointer;" ng-repeat="channel in getChannelsWithTriggers()">
                                            <div id="trigger-{{channel.moduleName}}" select-event="trigger">
                                                <div>
                                                    <a ng-click="removeTrigger($event)" ui-if="task.trigger && task.trigger.moduleName == channel.moduleName">
                                                        <i class="icon-remove icon-white close-channel"></i>
                                                    </a>
                                                    <img ng-src="../tasks/api/channel/icon?moduleName={{channel.moduleName}}&moduleVersion={{channel.moduleVersion}}" class="panel-img" />
                                                </div>
                                                <span>{{msg(channel.displayName)}}</span>
                                                <div class="content-task popover right" style="display:none; margin-left:125px;">
                                                    <h3 class="popover-title" style="display: block;">{{msg('tooltip.availableTriggers')}}</h3>
                                                    <div class="popover-content">
                                                        <ul>
                                                            <li ng-repeat="trigger in channel.triggerTaskEvents">
                                                                <a ng-click="selectTrigger(channel, trigger)">{{msg(trigger.displayName)}}</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div ng-hide="!task.trigger.subject">
                    <!------------------------ FILTER ------------------------>
                    <!--<div class="accordion" id="filter" ui-if="task.filters">
                        <div class="task-filter-group">
                            <div class="accordion-heading">
                                <div class="pull-right">
                                    <button ng-click="removeFilterSet()" class="btn btn-danger btn-in-heading" data-toggle="collapse">
                                        <i class="icon-remove icon-white"></i>
                                    </button>
                                </div>
                                <a class="accordion-toggle inbox-header" overflow-change="collapse-action" data-toggle="collapse" data-parent="#filter" href="#collapse-filter">
                                    {{msg('section.filters')}}
                                </a>
                            </div>
                            <div id="collapse-filter collapse in" class="accordion-body stripes-bg">
                                <div class="accordion-inner">
                                    <form id="filtersForm" name="filterForm" class="form-horizontal">
                                        <div class="margin-center">
                                            <div ng-repeat="filter in task.filters">
                                                <div class="form-inline">
                                                    <div class="control-group">
                                                        <span class="validation-area" ng-class="{error: !filter.eventParameter}">
                                                            <select ng-model="filter.eventParameter" class="input-medium" ng-options="msg(c.displayName) for c in selectedTrigger.eventParameters">
                                                                <option value="">{{msg('info.filter.select')}}</option>
                                                            </select>
                                                        </span>
                                                        <span class="validation-area" ng-class="{error: !filter.negationOperator}">
                                                            <select ng-disabled="!filter.eventParameter" ng-model="filter.negationOperator" ng-options="c.value as msg(c.key) for c in negationOperators" class="input-medium">
                                                                <option value="">{{msg('info.filter.select')}}</option>
                                                            </select>
                                                        </span>
                                                        <span class="validation-area" ng-class="{error: !filter.operator}">
                                                            <select ng-disabled="!filter.negationOperator" ng-model="filter.operator" class="input-medium" ng-options="msg(c) for c in operators(filter.eventParameter)" >
                                                                <option value="">{{msg('info.filter.select')}}</option>
                                                            </select>
                                                        </span>
                                                        <span class="validation-area" ng-class="{error: !filter.expression}">
                                                            <input ng-disabled="!filter.operator" ng-model="filter.expression" class="input-medium" ng-show="filter.operator!='exist'" type="text" value=""/>
                                                        </span>
                                                        <a ng-click="removeFilter(filter)" class="btn btn-small btn-danger"><i class="icon-trash icon-white"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <button ui-if="task.filters.length == 0" class="btn btn-success" ng-click="addFilter()"><i class="icon-plus icon-white"></i> {{msg('button.addFilter')}}</button>
                                            <button ui-if="task.filters.length != 0" class="btn btn-success" ng-click="addFilter()"><i class="icon-plus icon-white"></i> {{msg('button.addAnotherFilter')}}</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>-->

                    <!------------------ ADDITIONAL DATA ------------------------>
                    <!--<div class="accordion" id="accordion1" ng-hide="allDataSources == undefined || allDataSources.length == 0">
                        <div class="task-group">
                            <div class="accordion-heading">
                                <div class="pull-right" ng-show="draggedTrigger">
                                    <button class="btn btn-danger btn-in-heading" data-toggle="collapse" href="#collapse1"><i class="icon-remove icon-white"></i></button>
                                </div>
                                <a class="accordion-toggle inbox-header" overflow-change expandaccordion data-toggle="collapse" data-parent="#accordion1" href="#collapse1">
                                    <i class="icon-chevron-right"></i> {{msg('subsection.IncludeAdditionalData')}}
                                </a>
                            </div>
                            <div id="collapse1" class="accordion-body collapse stripes-bg">
                                <div class="accordion-inner">
                                    <div ng-repeat="dataSource in selectedDataSources">
                                        <div class="control-group control-section">
                                            <label class="control-label">{{msg('subsubsection.source')}} </label>
                                            <div class="controls">
                                                <div class="btn-group">
                                                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                                        {{msg(dataSource.name)}}
                                                        <span class="caret"></span>
                                                    </a>
                                                    <ul class="dropdown-menu">
                                                        <li ng-repeat="available in allDataSources">
                                                            <a ui-if="dataSource.name == available.name"><i class="icon-ok-sign"></i> {{msg(available.name)}}</a>
                                                            <a ui-if="dataSource.name != available.name && findDataSourceByName(selectedDataSources, available.name) != undefined"><i class="icon-ok-sign"></i> {{msg(available.name)}}</a>
                                                            <a ui-if="dataSource.name != available.name && findDataSourceByName(selectedDataSources, available.name) == undefined" ng-click="changeDataSource(dataSource, available)"><i></i> {{msg(available.name)}}</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="section" ng-hide="dataSource.name == undefined" ng-repeat="object in dataSource.objects">
                                            <div class="control-group control-section">
                                                <label class="control-label">{{msg('subsubsection.object')}} <span class="index-label"> #{{object.id}}</span></label>
                                                <div class="controls">
                                                    <div class="btn-group">
                                                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                                            {{msg(object.displayName)}}
                                                            <span class="caret"></span>
                                                        </a>
                                                        <ul class="dropdown-menu">
                                                            <li ng-repeat="obj in dataSource.available">
                                                                <a ui-if="object.type == obj.type"><i class="icon-ok-sign"></i> {{msg(obj.displayName)}}</a>
                                                                <a ui-if="object.type != obj.type" ng-click="selectObject(dataSource.name, object, obj)"><i></i> {{msg(obj.displayName)}}</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="control-group control-section" ng-hide="object.displayName == undefined">
                                                <label class="control-label">{{msg('subsubsection.lookup')}} </label>
                                                <div class="controls">
                                                    <div class="btn-group">
                                                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                                            {{msg(object.lookup.field)}}
                                                            <span class="caret"></span>
                                                        </a>
                                                        <ul class="dropdown-menu">
                                                            <li ng-repeat="i in object.lookupFields">
                                                                <a ui-if="object.lookup.field == i"><i class="icon-ok-sign"></i> {{msg(i)}}</a>
                                                                <a ui-if="object.lookup.field != i" ng-click="object.lookup.field = i"><i></i> {{msg(i)}}</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    <span> {{msg('equals') | lowercase}} </span>
                                                    <div class="btn-group">
                                                        <a class="btn" ng-click="showLookupValueModal(dataSource, object)">
                                                            {{object.lookup.displayName}}
                                                            <span class="caret"></span>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="control-group control-section">
                                                <label class="control-label">{{msg('subsubsection.failIfDataNotFound')}}</label>
                                                <div class="controls">
                                                    <div class="btn-group">
                                                        <input type="checkbox" ng-model="object.failIfDataNotFound"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="control-group move-element margin-before2" ng-hide="object.displayName == undefined">
                                                <p><strong>{{msg('subsubsection.objectFields')}}</strong></p>
                                                <span contenteditable="false" ng-repeat="i in object.fields" class="badge badge-warning triggerField" draggable
                                                data-prefix="ad" data-source="{{dataSource.name}}" data-object="{{object.displayName}}" data-object-type="{{object.type}}"
                                                data-field="{{i.fieldKey}}" data-index="{{$index}}" data-object-id="{{object.id}}" data-type="{{i.type}}">{{msg(i.displayName)}}</span>​
                                            </div>
                                        </div>

                                        <div class="margin-before control-group section2">
                                            <button class="btn btn-primary" ng-click="addObject(dataSource)"><i class="icon-white icon-plus"></i> {{msg('button.addObject', msg(dataSource.name))}}</button>
                                            <div id="addObjectNotification" class="notifications center" style="z-index: 9999;"></div>
                                        </div>
                                    </div>

                                    <div class="control-group section2" ng-hide="availableDataSources.length == 0">
                                        <button class="btn btn-warning" ng-click="addDataSource()"><i class="icon-white icon-plus"></i> {{msg('button.addDataSource')}}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>-->

                    <!------------------------ ADDING BUTTONS ------------------------>
                    <div class="row-fluid inside">
                        <div class="control-group centered">
                            <div class="btn-group">
                                <!--<button ui-if="!task.filters" class="btn btn-warning" ng-click="addFilterSet()"><i class="icon-plus icon-white"></i> {{msg('button.addFilter')}}</button>-->
                                <!--<button class="btn btn-warning" ng-click="addDataSource()"><i class="icon-white icon-plus"></i> {{msg('button.addDataSource')}}</button>-->
                                <button ui-if="!task.action" class="btn btn-warning" ng-click="addAction()"><i class="icon-white icon-plus"></i> {{msg('button.addAction')}}</button>
                            </div>
                        </div>
                    </div>

                    <!------------------------  ACTION  ------------------------->
                    <div class="accordion" id="action" ng-show="task.action">
                        <div class="task-group">
                            <div class="accordion-heading">
                                <div class="pull-right">
                                    <button ng-click="removeAction()" class="btn btn-danger btn-in-heading" data-toggle="collapse">
                                        <i class="icon-remove icon-white"></i>
                                    </button>
                                </div>
                                <a class="accordion-toggle inbox-header" overflow-change="collapse-action" data-toggle="collapse" data-parent="#action" href="#collapse-action">
                                    {{msg('header.action')}}
                                    <span ng-hide="!task.action.displayName">
                                        &raquo; {{msg(task.action.channelName)}} : {{msg(task.action.displayName)}}
                                    </span>
                                </a>
                            </div>
                            <div id="collapse-action" class="accordion-body stripes-bg collapse in" style="overflow: visible;">
                                <div class="accordion-inner inside">
                                    <h4>{{msg('info.availableFields')}}:</h4>
                                    <div class="control-group move-element">
                                        <span contenteditable="false" ng-repeat="i in selectedTrigger.eventParameters" class="badge badge-info triggerField" draggable data-prefix="trigger" data-index="{{$index}}" data-type="{{i.type}}">{{msg(i.displayName)}}</span>​
                                    </div>
                                    <div class="control-group">
                                        <span>{{msg('channel')}}:</span>
                                        <div class="btn-group">
                                            <button class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                                {{msg(selectedActionChannel.displayName || 'select')}}
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li ng-repeat="channel in getChannelsWithActions()">
                                                    <a ng-click="selectActionChannel(channel)">{{msg(channel.displayName)}}</a>
                                                </li>
                                            </ul>
                                        </div>
                                        <span>{{msg('action')}}:</span>
                                        <div class="btn-group">
                                            <button class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                                {{msg(selectedAction.displayName || 'select')}}
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li ng-repeat="action in getActions()">
                                                    <a ng-click="selectAction(action)">{{msg(action.displayName)}}</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="control-group" ng-show="selectedAction.description">
                                        <label class="control-label">{{msg(selectedAction.description)}}</label>
                                    </div>
                                    <div ui-if="selectedAction">
                                        <div ng-class="actionCssClass(i)" ng-repeat="i in selectedAction.actionParameters" class="control-group form-inline clearfix">
                                            <label class="control-label tip">
                                                {{msg(i.displayName)}}
                                                <!------------------------ Tooltips ------------------------>
                                                <span class="help-inline" ui-if="i.type == 'LIST'" help-popover="list" data-title="{{msg('header.listHelp')}}"><i class="icon-question-sign"></i></span>
                                                <span class="help-inline" ui-if="i.type == 'MAP'" help-popover="map" data-title="{{msg('header.mapHelp')}}"><i class="icon-question-sign"></i></span>
                                            </label>

                                            <!------------------------ Chrome & IE ------------------------>
                                            <div ui-if="BrowserDetect.browser=='Chrome' || BrowserDetect.browser=='Explorer'" class="controls">
                                                <editable-content ui-if="i.type == 'UNICODE'" data="i" index="$index" type="UNICODE"></editable-content>
                                                <editable-content ui-if="i.type == 'TEXTAREA' || i.type == 'MAP' || i.type == 'LIST'" data="i" index="$index" type="TEXTAREA"></editable-content>
                                                <editable-content ui-if="i.type == 'INTEGER' || i.type == 'LONG'" data="i" index="$index" type="INTEGER"></editable-content>
                                                <editable-content ui-if="i.type == 'DOUBLE'" data="i" index="$index" type="DOUBLE"></editable-content>
                                                <editable-content ui-if="i.type == 'TIME'" data="i" index="$index" type="TIME"></editable-content>
                                                <editable-content ui-if="i.type == 'DATE'" data="i" index="$index" type="DATE"></editable-content>
                                                <div ui-if="i.type == 'BOOLEAN'">
                                                    <label class="control-label radio inline span2 no-margin-top">
                                                        <input type="radio" class="input-block-level" ng-checked="checkedBoolean($index, 'true')" ng-click="setBooleanValue($index, true)"/> {{msg('yes')}}
                                                    </label>
                                                    <label class="control-label radio inline span2 no-margin-top">
                                                        <input type="radio" class="input-block-level" ng-checked="checkedBoolean($index, 'false')" ng-click="setBooleanValue($index, false)"/> {{msg('no')}}
                                                    </label>
                                                    <label class="control-label inline span8 no-margin-bottom">
                                                        <editable-content data="i" index="$index" type="BOOLEAN"></editable-content>
                                                    </label>
                                                </div>
                                            </div>

                                            <!------------------------ Other browsers  ------------------------>
                                            <div ui-if="BrowserDetect.browser!='Chrome' && BrowserDetect.browser!='Explorer'" class="controls">
                                                <textarea ui-if="i.type == 'TEXTAREA' || i.type == 'MAP' || i.type == 'LIST'" rows="5" ng-model="i.value" droppable class="actionField span8" data-index="{{$index}}" data-type="{{i.type}}"></textarea>
                                                <input ui-if="i.type == 'INTEGER' || i.type == 'LONG'" type="text" ng-model="i.value" droppable class="actionField span8" data-index="{{$index}}" data-type="{{i.type}}" integer placeholder="{{msg('placeholder.numberOnly')}}"/>
                                                <input ui-if="i.type == 'DOUBLE'" type="text" ng-model="i.value" droppable class="actionField span8" data-index="{{$index}}" data-type="{{i.type}}" integer placeholder="{{msg('placeholder.numberOnly')}}"/>
                                                <input ui-if="i.type == 'UNICODE'" type="text" ng-model="i.value" droppable class="actionField span8" data-index="{{$index}}" data-type="{{i.type}}"/>
                                                <input ui-if="i.type == 'DATE'" type="text" ng-model="i.value" droppable class="actionField span8" data-index="{{$index}}" data-type="{{i.type}}" datetime-picker-input placeholder="{{msg('placeholder.dateOnly')}}" readonly="readonly" style="background:white;"/>
                                                <input ui-if="i.type == 'TIME'" type="text" ng-model="i.value" droppable class="actionField span8" data-index="{{$index}}" data-type="{{i.type}}" time-picker-input placeholder="{{msg('placeholder.timeOnly')}}" readonly="readonly" style="background:white;"/>
                                                <div ui-if="i.type == 'BOOLEAN'">
                                                    <label class="radio help-inline">
                                                        <input type="radio" ng-model="i.value" class="input-block-level" value="true"/> {{msg('yes')}}
                                                    </label>
                                                    <label class="radio help-inline">
                                                        <input type="radio" ng-model="i.value" class="input-block-level" value="false"/> {{msg('no')}}
                                                    </label>
                                                    <label class="help-inline input-xlarge-fluid">
                                                        <input type="text" value="{{getBooleanValue(i.value)}}" droppable class="actionField" data-index="{{$index}}" data-type="{{i.type}}" placeholder="{{msg('placeholder.booleanOnly')}}" readonly="readonly" style="background:white;"/>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!------------------------ Help button  ------------------------>
                                        <a ui-if="BrowserDetect.browser!='Chrome' && BrowserDetect.browser!='Explorer'" href="#helpModalDate" role="button" class="btn btn-primary" data-toggle="modal">{{msg('help')}}</a>

                                        <a class="btn btn-success" data-toggle="collapse" data-target="#collapse-action">{{msg('done')}}</a>
                                        <!------------------------ Help Manipulation  ------------------------>
                                        <div class="control-group" ng-include="'../tasks/partials/help/manipulation.html'"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!------------------------ SAVE ------------------------>
                    <div class="control-group inside">
                        <h4 class="margin-center centered spn9">{{msg('section.save')}}</h4>
                        <p class="centered spn9 margin-center">{{msg('info.addSave')}}</p>
                        <div class="control-group centered inside">
                            <input ng-disabled="!validateForm()" type="button" ng-click="save(true)" class="btn btn-primary" value="{{msg('button.saveAndEnable')}}"/>
                            <input ng-disabled="!validateForm()" type="button" ng-click="save(false)" class="btn btn-success" value="{{msg('button.save')}}"/>
                            <a href="#/task/" class="btn"> {{msg('button.cancel')}}</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<pre>{{ task | json }}</pre>